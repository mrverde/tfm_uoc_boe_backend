import requests
from fastapi.testclient import TestClient
from unittest.mock import patch

GET_BOE_BODY_RESPONSE = '<?xml version="1.0" encoding="UTF-8"?>\n<documento fecha_actualizacion="20231225071519">\n  <metadatos>\n    <identificador>BOE-A-2023-26170</identificador>\n    <origen_legislativo codigo="1">Estatal</origen_legislativo>\n    <departamento codigo="4510">Ministerio Fiscal</departamento>\n    <rango codigo="1510">Decreto</rango>\n    <fecha_disposicion>20231205</fecha_disposicion>\n    <numero_oficial/>\n    <titulo>Decreto de 5 de diciembre de 2023, del Fiscal General del Estado, por el que se nombra Fiscal Decano en la Fiscalía Superior de Illes Balears, para la coordinación y dirección de la Sección Especializada Antidroga, a don Adrián Salazar Larracoechea.</titulo>\n    <diario codigo="BOE">Boletín Oficial del Estado</diario>\n    <fecha_publicacion>20231225</fecha_publicacion>\n    <diario_numero>307</diario_numero>\n    <seccion>2</seccion>\n    <subseccion>A</subseccion>\n    <pagina_inicial>171113</pagina_inicial>\n    <pagina_final>171114</pagina_final>\n    <suplemento_pagina_inicial/>\n    <suplemento_pagina_final/>\n    <url_pdf>/boe/dias/2023/12/25/pdfs/BOE-A-2023-26170.pdf</url_pdf>\n    <url_epub/>\n    <url_pdf_catalan/>\n    <url_pdf_euskera/>\n    <url_pdf_gallego/>\n    <url_pdf_valenciano/>\n    <estatus_legislativo/>\n    <fecha_vigencia/>\n    <estatus_derogacion>N</estatus_derogacion>\n    <fecha_derogacion/>\n    <judicialmente_anulada>N</judicialmente_anulada>\n    <fecha_anulacion/>\n    <vigencia_agotada>N</vigencia_agotada>\n    <estado_consolidacion codigo=""/>\n    <letra_imagen>A</letra_imagen>\n    <suplemento_letra_imagen/>\n  </metadatos>\n  <analisis>\n    <materias/>\n    <notas/>\n    <referencias>\n      <anteriores/>\n      <posteriores/>\n    </referencias>\n    <alertas/>\n  </analisis>\n  <texto>\n    <p class="centro_negrita">Hechos</p>\n    <p class="articulo">Primero.</p>\n    <p class="parrafo_2">El\xa027 de noviembre de\xa02023 se recibió en la FGE un oficio del Excmo. Sr. Fiscal Superior de la Fiscalía de la Comunidad de las Islas Baleares, remitiendo a la Inspección Fiscal un escrito en el que propuso el nombramiento del Ilmo. Sr. Fiscal don Adrián Salazar Larracoechea como decano coordinador encargado del área especializada antidroga en la Fiscalía Superior. El Sr. Salazar Larracoechea es actualmente fiscal delegado de la Fiscalía Especial Antidroga en el mismo órgano fiscal.</p>\n    <p class="parrafo">El escrito venía complementado por la justificación de que el Excmo. Sr. Fiscal Superior había comunicado a toda la plantilla la oferta de la plaza, a la que ha concurrido un solo interesado. La propuesta del Fiscal Superior se acompaña también de la solicitud y el currículo profesional del único candidato, mostrando su parecer favorable a la designación del Ilmo. Sr. don Adrián Salazar Larracoechea, ponderando los méritos que posee para desempeñar el cargo.</p>\n    <p class="articulo">Segundo.</p>\n    <p class="parrafo">Con motivo de la jubilación de la anterior fiscal decana para esa coordinación en la Fiscalía de la Comunidad de Islas Baleares, el Fiscal Superior comunicó a todos los miembros de la plantilla que quien estuviera interesado debía formular la correspondiente solicitud. El único solicitante ha aportado su <em>curriculum vitae </em>y tiene acreditada suficiente experiencia y formación, por lo que el Fiscal Superior propone a don Adrián Salazar Larracoechea, justificando la decisión. La solicitud con la propuesta favorable ha sido elevada por el Fiscal Superior a la Inspección de la Fiscalía General del Estado, destacando los méritos que hacen a don Adrián idóneo para desempeñar el cargo.</p>\n    <p class="parrafo">Por tanto, constan la propuesta del Excmo. Sr. Fiscal Superior remitida a la Inspección Fiscal, habiendo sido oído en el mismo sentido el Consejo Fiscal [artículo\xa03.d) del Real Decreto 437/1983].</p>\n    <p class="centro_negrita">Fundamentos de Derecho</p>\n    <p class="articulo">Primero.</p>\n    <p class="parrafo">El Estatuto Orgánico del Ministerio Fiscal dispone que los fiscales decanos de las Fiscalías serán nombrados mediante resolución dictada por el Fiscal General del Estado, a propuesta motivada del Fiscal Jefe respectivo. El mismo precepto exige que, para la cobertura de estos cargos y con carácter previo, se realice una convocatoria entre los fiscales de la plantilla, así como que la propuesta se acompañe de una relación de todos los que lo hayan solicitado, con aportación de los méritos alegados (artículo\xa036.4).</p>\n    <p class="parrafo">Por su parte, el artículo\xa061 del Reglamento del Ministerio Fiscal (Real Decreto 305/2022, de\xa03 de mayo), establece que los fiscales decanos a los que se refiere el artículo\xa036.4 EOMF serán nombrados, tras convocatoria pública entre los fiscales de la plantilla, mediante Decreto de la persona titular de la Fiscalía General del Estado previa propuesta motivada del Fiscal Jefe, remitida a través de la Inspección Fiscal, que ha elevado informe favorable a la propuesta formulada. Ha sido oído el Consejo Fiscal.</p>\n    <p class="parrafo">En la solicitud informada, el solicitante ha acreditado formación, méritos e idoneidad para desempeño del contenido funcional concreto que le asigna a la plaza.</p>\n    <p class="articulo">Segundo.</p>\n    <p class="parrafo">Se han llevado a cabo, por tanto, todos los trámites previstos para proceder al nombramiento interesado. La propuesta informada está suficientemente motivada y avala la idoneidad del candidato propuesto. En consecuencia, vista la propuesta formulada y el informe de la Inspección Fiscal, de conformidad con las previsiones del Estatuto Orgánico del Ministerio Fiscal y del RMF, y haciendo propia la fundamentación de la propuesta, acuerdo:</p>\n    <p class="parrafo_2">1.\u2003Nombrar al Ilmo. Sr. don Adrián Salazar Larracoechea fiscal decano en la Fiscalía Superior de Islas Baleares, para la coordinación y dirección de la Sección Especializada Antidroga.</p>\n    <p class="parrafo">2.\u2003Notificar este Decreto a la Excma. Sra. Fiscal Jefa Antidroga, al Excmo. Sr. Fiscal Superior de Islas Baleares, que lo trasladará al fiscal interesado, y al Ministerio de Justicia, con entrega de copias de la resolución.</p>\n    <p class="parrafo">3.\u2003Publíquese el presente nombramiento en el «Boletín Oficial del Estado».</p>\n    <p class="parrafo">4.\u2003Contra el presente Decreto, que pone fin a la vía administrativa de conformidad con lo dispuesto en el artículo\xa0114 de la Ley\xa039/2015, de\xa01 de octubre, de Procedimiento Administrativo Común de las Administraciones Públicas, cabe interponer en el plazo de un mes recurso potestativo de reposición, a contar desde el día siguiente a su publicación ante la Fiscalía General del Estado (C/Fortuny, n° 4, Madrid\xa028010) en los términos establecidos por el artículo\xa0123 y concordantes de aquella ley o, alternativamente, recurso contencioso-administrativo ante la Sala de lo Contencioso Administrativo del Tribunal Supremo, según lo establecido en los artículos\xa010, 12 y\xa014.1 regla\xa01.ª de la Ley\xa029/1998, de\xa013 de julio, reguladora de la Jurisdicción Contencioso Administrativa, en el plazo de dos meses a contar desde el día siguiente a su publicación, conforme a lo dispuesto en el artículo\xa046 de esa misma ley.</p>\n    <p class="parrafo_2">Madrid, 5 de diciembre de\xa02023.–El Fiscal General del Estado,\xa0Álvaro García Ortiz.</p>\n  </texto>\n</documento>\n'

GET_BOE_SUMMARY_CONTENT = '<?xml version="1.0" encoding="UTF-8"?>\n<sumario>\n  <meta>\n    <pub>BOE</pub>\n    <anno>2023</anno>\n    <fecha>25/12/2023</fecha>\n    <fechaInv>2023/12/25</fechaInv>\n    <fechaAnt>23/12/2023</fechaAnt>\n    <fechaAntAnt>22/12/2023</fechaAntAnt>\n    <fechaSig></fechaSig>\n    <fechaPub>lunes 25 de diciembre de 2023</fechaPub>\n    <pubDate>Mon, 25 Dec 2023 00:00:00 +0100</pubDate>\n  </meta>\n  <diario nbo="307">\n    <sumario_nbo id="BOE-S-2023-307">\n      <urlPdf szBytes="251097" szKBytes="245">/boe/dias/2023/12/25/pdfs/BOE-S-2023-307.pdf</urlPdf>\n    </sumario_nbo>\n    <seccion num="2A" nombre="II. Autoridades y personal. - A. Nombramientos, situaciones e incidencias">\n      <departamento nombre="MINISTERIO FISCAL" etq="4510">\n        <epigrafe nombre="Nombramientos">\n          <item id="BOE-A-9999-99999" control="2023/26320">\n            <titulo>Decreto de 4 de diciembre de 2023, del Fiscal General del Estado, por el que se nombra Fiscal Delegado de la Fiscalía Especial Antidroga en la Fiscalía Provincial de A Coruña a don Javier Arias Francés.</titulo>\n            <urlPdf szBytes="205110" szKBytes="200" numPag="2">/boe/dias/2023/12/25/pdfs/BOE-A-2023-26169.pdf</urlPdf>\n            <urlHtm>/diario_boe/txt.php?id=BOE-A-2023-26169</urlHtm>\n            <urlXml>/diario_boe/xml.php?id=BOE-A-2023-26169</urlXml>\n          </item>\n          <item id="BOE-A-0000-00000" control="2023/26321">\n            <titulo>Decreto de 5 de diciembre de 2023, del Fiscal General del Estado, por el que se nombra Fiscal Decano en la Fiscalía Superior de Illes Balears, para la coordinación y dirección de la Sección Especializada Antidroga, a don Adrián Salazar Larracoechea.</titulo>\n            <urlPdf szBytes="199403" szKBytes="195" numPag="2">/boe/dias/2023/12/25/pdfs/BOE-A-0000-00000.pdf</urlPdf>\n            <urlHtm>/diario_boe/txt.php?id=BOE-A-0000-00000</urlHtm>\n            <urlXml>/diario_boe/xml.php?id=BOE-A-0000-00000</urlXml>\n          </item>\n        </epigrafe>\n      </departamento>\n    </seccion>\n  </diario>\n</sumario>\n'

GET_BOE_DATA_SUMMARY_RESPONSE = '[["25\\/12\\/2023","2A","II. Autoridades y personal. - A. Nombramientos, situaciones e incidencias","MINISTERIO FISCAL","4510","Nombramientos","BOE-A-0000-00000","2023\\/26321","Decreto de 5 de diciembre de 2023, del Fiscal General del Estado, por el que se nombra Fiscal Decano en la Fiscalía Superior de Illes Balears, para la coordinación y dirección de la Sección Especializada Antidroga, a don Adrián Salazar Larracoechea.","\\/boe\\/dias\\/2023\\/12\\/25\\/pdfs\\/BOE-A-0000-00000.pdf","\\/diario_boe\\/txt.php?id=BOE-A-0000-00000","\\/diario_boe\\/xml.php?id=BOE-A-0000-00000"]]'


async def test_get_boe(client, fastapi_app):
    client = TestClient(fastapi_app)
    url = fastapi_app.url_path_for("get_boe")
    mocked_response = requests.Response()
    mocked_response.status_code = 200
    mocked_response._content = GET_BOE_BODY_RESPONSE.encode('utf-8')

    with patch("requests.get", return_value=mocked_response) as mocked_request:
        response = client.get(url, params={"boe_xml_address":"/diario_boe/xml.php?id=BOE-A-9999-99999"})

    assert mocked_request.call_count == 1
    called_urls = [call.args[0] for call in mocked_request.call_args_list]
    assert called_urls[0] == "https://boe.es/diario_boe/xml.php?id=BOE-A-9999-99999"
    assert response.status_code == 200


async def test_get_all_boe(client, fastapi_app):
    client = TestClient(fastapi_app)
    url = fastapi_app.url_path_for("get_all_boe_data")
    mocked_response_get_all = requests.Response()
    mocked_response_get_all.status_code = 200
    mocked_response_get_all._content = GET_BOE_SUMMARY_CONTENT.encode('utf-8')

    mocked_response_get = requests.Response()
    mocked_response_get.status_code = 200
    mocked_response_get._content = GET_BOE_BODY_RESPONSE.encode('utf-8')

    with patch("requests.get", side_effect=[mocked_response_get_all, mocked_response_get]) as mocked_request:
        response = client.get(url, params={"date":"20999999"})

    assert mocked_request.call_count == 2
    called_urls = [call.args[0] for call in mocked_request.call_args_list]
    assert called_urls[0] == "https://boe.es/diario_boe/xml.php?id=BOE-S-20999999"
    assert called_urls[1] == "https://boe.es/diario_boe/xml.php?id=BOE-A-0000-00000"
    assert response.status_code == 200


async def test_get_boe_data_summary(client, fastapi_app):
    client = TestClient(fastapi_app)
    url = fastapi_app.url_path_for("get_boe_data_summary")
    mocked_response_get_all = requests.Response()
    mocked_response_get_all.status_code = 200
    mocked_response_get_all._content = GET_BOE_SUMMARY_CONTENT.encode('utf-8')

    with patch("requests.get", side_effect=[mocked_response_get_all]) as mocked_request:
        response = client.get(url, params={"date":"20999999"})

    assert mocked_request.call_count == 1
    called_urls = [call.args[0] for call in mocked_request.call_args_list]
    assert called_urls[0] == "https://boe.es/diario_boe/xml.php?id=BOE-S-20999999"
    assert response.status_code == 200
    assert response.text == GET_BOE_DATA_SUMMARY_RESPONSE
